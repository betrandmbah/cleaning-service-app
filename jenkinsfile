pipeline {
  agent any

  environment {
    AWS_REGION = "us-east-1"
    ACCOUNT_ID = "439891535932"
    ECR        = "${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
    CLUSTER    = "cleaning-eks"
    NAMESPACE  = "cleaning"
    TAG        = "${BUILD_NUMBER}"
  }

  stages {
    stage('Checkout') {
      steps { checkout scm }
    }

    stage('ECR Login') {
      steps {
        sh '''
          aws --version
          kubectl version --client=true
          aws ecr get-login-password --region $AWS_REGION \
            | docker login --username AWS --password-stdin $ECR
        '''
      }
    }

    stage('Build & Push Images') {
      steps {
        sh '''
          set -e

          build_push () {
            NAME=$1
            DIR=$2
            echo "Building $NAME from $DIR"
            docker build -t $NAME:$TAG $DIR
            docker tag $NAME:$TAG $ECR/$NAME:$TAG
            docker push $ECR/$NAME:$TAG
          }

          build_push user-service ./user-service
          build_push booking-service ./booking-service
          build_push payment-service ./payment-service
          build_push worker-service ./worker-service
          build_push api-gateway ./api-gateway
          build_push frontend ./frontend
        '''
      }
    }

    stage('Configure kubectl for EKS') {
      steps {
        sh '''
          aws eks update-kubeconfig --region $AWS_REGION --name $CLUSTER
          kubectl get ns
        '''
      }
    }

    stage('Deploy to EKS') {
      steps {
        sh '''
          set -e

          kubectl -n $NAMESPACE set image deployment/user-service user-service=$ECR/user-service:$TAG
          kubectl -n $NAMESPACE set image deployment/booking-service booking-service=$ECR/booking-service:$TAG
          kubectl -n $NAMESPACE set image deployment/payment-service payment-service=$ECR/payment-service:$TAG
          kubectl -n $NAMESPACE set image deployment/worker-service worker-service=$ECR/worker-service:$TAG
          kubectl -n $NAMESPACE set image deployment/api-gateway api-gateway=$ECR/api-gateway:$TAG
          kubectl -n $NAMESPACE set image deployment/frontend frontend=$ECR/frontend:$TAG

          kubectl -n $NAMESPACE rollout status deployment/user-service
          kubectl -n $NAMESPACE rollout status deployment/booking-service
          kubectl -n $NAMESPACE rollout status deployment/payment-service
          kubectl -n $NAMESPACE rollout status deployment/worker-service
          kubectl -n $NAMESPACE rollout status deployment/api-gateway
          kubectl -n $NAMESPACE rollout status deployment/frontend

          kubectl -n $NAMESPACE get pods -o wide
        '''
      }
    }
  }
}
